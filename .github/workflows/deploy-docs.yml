name: Deploy Docs to GitHub Pages

on:
  # Run on pushes to the main branch
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Grant permissions to deploy to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # This is crucial for pulling in your microservice submodules
          submodules: 'recursive'
          # We need the full git history to find last modified dates
          fetch-depth: 0 

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Build Documentation Site
        run: |
          # 1. Create the root directory for our static site
          mkdir _site
          touch _site/.nojekyll
          
          # 2. Create the main index page (the "Project Map")
          echo "<h1>Project Documentation</h1>" > _site/index.md
          echo "Auto-generated map of all microservices." >> _site/index.md
          echo "" >> _site/index.md
          echo "## Project Services" >> _site/index.md
          
          # 3. Find all .dsc files and build a page for each one
          find . -path ./.git -prune -o -name "*.dsc" -print | while read -r dsc_file; do
            
            # --- Get Paths and Names ---
            SERVICE_DIR=$(dirname "$dsc_file")
            # Get a clean relative path like "microservice-auth"
            PAGE_PATH=$(echo "$SERVICE_DIR" | cut -c 3-)
            # Get the service name like "microservice-auth"
            SERVICE_NAME=$(basename "$SERVICE_DIR")
            
            # --- Create Page ---
            TARGET_DIR="_site/$PAGE_PATH"
            mkdir -p "$TARGET_DIR"
            TARGET_MD="$TARGET_DIR/index.md"
            
            echo "Building page for $SERVICE_NAME..."
            
            # --- Add Main Title ---
            echo "# $SERVICE_NAME" > "$TARGET_MD"
            
            # --- 1. Add Description from .dsc file ---
            echo "## Description" >> "$TARGET_MD"
            cat "$dsc_file" >> "$TARGET_MD"
            
            # --- 2. Add Dependencies (as you suggested) ---
            REQ_FILE="$SERVICE_DIR/requirements.txt"
            if [ -f "$REQ_FILE" ]; then
              echo -e "\n## Python Dependencies" >> "$TARGET_MD"
              echo '```' >> "$TARGET_MD"
              cat "$REQ_FILE" >> "$TARGET_MD"
              echo '```' >> "$TARGET_MD"
            fi
            
            PKG_JSON_FILE="$SERVICE_DIR/package.json"
            if [ -f "$PKG_JSON_FILE" ]; then
              echo -e "\n## Node.js Dependencies" >> "$TARGET_MD"
              echo '```json' >> "$TARGET_MD"
              # Use jq to nicely print dependencies (if jq is installed, otherwise just cat)
              if command -v jq &> /dev/null; then
                  jq '.dependencies' "$PKG_JSON_FILE" >> "$TARGET_MD"
              else
                  cat "$PKG_JSON_FILE" >> "$TARGET_MD"
              fi
              echo '```' >> "$TARGET_MD"
            fi
            
            # --- 3. Add Directory Tree ---
            echo -e "\n## Directory Tree" >> "$TARGET_MD"
            echo '```' >> "$TARGET_MD"
            (cd "$SERVICE_DIR" && tree -L 2 -I 'node_modules|*.pyc|.git') >> "$TARGET_MD"
            echo '```' >> "$TARGET_MD"

            # --- 4. Add Last Modified Date ---
            echo -e "\n## Last Modified (in Git)" >> "$TARGET_MD"
            echo '```' >> "$TARGET_MD"
            (cd "$SERVICE_DIR" && git log -1 --pretty="format:%ci" .) >> "$TARGET_MD"
            echo '```' >> "$TARGET_MD"

            # --- 5. Add Link to Main Index Page ---
            echo "* [$SERVICE_NAME](./$PAGE_PATH/)" >> _site/index.md
            
          done
          
          echo "Docs build complete."
          tree _site # Optional: for debugging

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
