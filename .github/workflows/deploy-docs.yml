name: Deploy Docs to GitHub Pages

on:
  # Run on pushes to the main branch
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Grant permissions to deploy to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # This is crucial for pulling in your microservice submodules
          submodules: 'recursive'
          # We need the full git history to find last modified dates
          fetch-depth: 0 

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Build Documentation Site
        run: |
          # 1. Create the root directory
          mkdir _site
          
          # 2. Add .nojekyll file to disable Jekyll
          touch _site/.nojekyll
          
          # 3. Create the main index page
          #    *** CHANGED .md to .html ***
          echo "<h1>Project Documentation</h1>" > _site/index.html
          echo "Auto-generated map of all microservices." >> _site/index.html
          echo "" >> _site/index.html
          echo "<h2>Project Services</h2>" >> _site/index.html
          
          # 4. Find all .dsc files and build a page for each
          find . -path ./.git -prune -o \( -name ".dsc" -o -name "*.dsc" \) -print | while read -r dsc_file; do
            
            # --- Get Paths and Names ---
            SERVICE_DIR=$(dirname "$dsc_file")
            PAGE_PATH=$(echo "$SERVICE_DIR" | cut -c 3-) # Remove leading ./
            SERVICE_NAME=$(basename "$SERVICE_DIR")
            
            if [ "$SERVICE_DIR" == "." ]; then
              continue
            fi
            
            # --- Create Page ---
            TARGET_DIR="_site/$PAGE_PATH"
            mkdir -p "$TARGET_DIR"
            
            #    *** CHANGED .md to .html ***
            TARGET_HTML="$TARGET_DIR/index.html"
            
            echo "Building page for $SERVICE_NAME..."
            
            # --- Add Main Title & Description ---
            # We still write in Markdown format, but to an .html file
            # The browser will render the Markdown just fine.
            echo "<h1>$SERVICE_NAME</h1>" > "$TARGET_HTML"
            
            echo "<h2>Description</h2>" >> "$TARGET_HTML"
            # Use <pre> tag to preserve formatting from the .dsc file
            echo "<pre>" >> "$TARGET_HTML"
            cat "$dsc_file" >> "$TARGET_HTML"
            echo "</pre>" >> "$TARGET_HTML"
            
            # --- Add Dependencies (optional) ---
            REQ_FILE="$SERVICE_DIR/requirements.txt"
            if [ -f "$REQ_FILE" ]; then
              echo -e "\n<h2>Python Dependencies</h2>" >> "$TARGET_HTML"
              echo "<pre>" >> "$TARGET_HTML"
              cat "$REQ_FILE" >> "$TARGET_HTML"
              echo "</pre>" >> "$TARGET_HTML"
            fi
            
            # --- Add Directory Tree ---
            echo -e "\n<h2>Directory Tree</h2>" >> "$TARGET_HTML"
            echo "<pre>" >> "$TARGET_HTML"
            (cd "$SERVICE_DIR" && tree -L 2 -I 'node_modules|*.pyc|.git') >> "$TARGET_HTML"
            echo "</pre>" >> "$TARGET_HTML"

            # --- Add Last Modified Date ---
            echo -e "\n<h2>Last Modified (in Git)</h2>" >> "$TARGET_HTML"
            echo "<pre>" >> "$TARGET_HTML"
            (cd "$SERVICE_DIR" && git log -1 --pretty="format:%ci" .) >> "$TARGET_HTML"
            echo "</pre>" >> "$TARGET_HTML"

            # --- 5. Add Link to Main Index Page ---
            #    *** CHANGED .md to .html ***
            # The link format ./$PAGE_PATH/ is still correct, as it points to the directory
            echo "<li><a href=\"./$PAGE_PATH/\">$SERVICE_NAME</a></li>" >> _site/index.html
            
          done
          
          echo "Docs build complete. Final structure:"
          tree _site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
