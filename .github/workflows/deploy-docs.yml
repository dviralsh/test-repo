name: Deploy Docs to GitHub Pages

on:
  # Run on pushes to the main branch
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Grant permissions to deploy to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # This is crucial for pulling in your microservice submodules
          submodules: 'recursive'
          # We need the full git history to find last modified dates
          fetch-depth: 0 

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Build Documentation Site
        run: |
          # 1. Create the root directory
          mkdir _site
          
          # 2. Add .nojekyll file
          touch _site/.nojekyll
          
          # --- NEW ---
          # 3. Copy the stylesheet
          cp .github/style.css _site/style.css
          
          # 4. Create the main index.html page
          echo "<!DOCTYPE html>" > _site/index.html
          echo "<html lang='en'>" >> _site/index.html
          echo "<head>" >> _site/index.html
          echo "  <meta charset='UTF-8'>" >> _site/index.html
          echo "  <meta name='viewport' content='width=device-width, initial-scale=1.0'>" >> _site/index.html
          echo "  <title>Project Documentation</title>" >> _site/index.html
          echo "  <link rel='stylesheet' href='style.css'>" >> _site/index.html
          echo "</head>" >> _site/index.html
          echo "<body>" >> _site/index.html
          echo "<main>" >> _site/index.html
          echo "  <h1>Project Documentation</h1>" >> _site/index.html
          echo "  <p>Auto-generated map of all microservices.</p>" >> _site/index.html
          echo "  <h2>Project Services</h2>" >> _site/index.html
          echo "  <ul>" >> _site/index.html # Use a list
          
          # 5. Find and build all service pages
          find . -path ./.git -prune -o \( -name ".dsc" -o -name "*.dsc" \) -print | while read -r dsc_file; do
            
            SERVICE_DIR=$(dirname "$dsc_file")
            PAGE_PATH=$(echo "$SERVICE_DIR" | cut -c 3-)
            SERVICE_NAME=$(basename "$SERVICE_DIR")
            
            if [ "$SERVICE_DIR" == "." ]; then continue; fi
            
            TARGET_DIR="_site/$PAGE_PATH"
            mkdir -p "$TARGET_DIR"
            TARGET_HTML="$TARGET_DIR/index.html"
            
            echo "Building page for $SERVICE_NAME..."
            
            # --- Build the service's HTML file ---
            echo "<!DOCTYPE html>" > "$TARGET_HTML"
            echo "<html lang='en'>" >> "$TARGET_HTML"
            echo "<head>" >> "$TARGET_HTML"
            echo "  <meta charset='UTF-8'>" >> "$TARGET_HTML"
            echo "  <meta name='viewport' content='width=device-width, initial-scale=1.0'>" >> "$TARGET_HTML"
            echo "  <title>$SERVICE_NAME</title>" >> "$TARGET_HTML"
            #   --- NEW: Relative path to CSS ---
            echo "  <link rel='stylesheet' href='../../style.css'>" >> "$TARGET_HTML"
            echo "</head>" >> "$TARGET_HTML"
            echo "<body>" >> "$TARGET_HTML"
            echo "<main>" >> "$TARGET_HTML"
            echo "  <h1>$SERVICE_NAME</h1>" >> "$TARGET_HTML"
            echo "  <a href='../..'>&larr; Back to Project Map</a>" >> "$TARGET_HTML"
            
            echo "  <h2>Description</h2>" >> "$TARGET_HTML"
            echo "  <pre>" >> "$TARGET_HTML"
            cat "$dsc_file" >> "$TARGET_HTML"
            echo "  </pre>" >> "$TARGET_HTML"
            
            REQ_FILE="$SERVICE_DIR/requirements.txt"
            if [ -f "$REQ_FILE" ]; then
              echo -e "\n  <h2>Python Dependencies</h2>" >> "$TARGET_HTML"
              echo "  <pre>" >> "$TARGET_HTML"
              cat "$REQ_FILE" >> "$TARGET_HTML"
              echo "  </pre>" >> "$TARGET_HTML"
            fi
            
            echo -e "\n  <h2>Directory Tree</h2>" >> "$TARGET_HTML"
            echo "  <pre>" >> "$TARGET_HTML"
            (cd "$SERVICE_DIR" && tree -L 2 -I 'node_modules|*.pyc|.git') >> "$TARGET_HTML"
            echo "  </pre>" >> "$TARGET_HTML"

            echo -e "\n  <h2>Last Modified (in Git)</h2>" >> "$TARGET_HTML"
            echo "  <pre>" >> "$TARGET_HTML"
            (cd "$SERVICE_DIR" && git log -1 --pretty="format:%ci" .) >> "$TARGET_HTML"
            echo "  </pre>" >> "$TARGET_HTML"
            
            echo "</main>" >> "$TARGET_HTML"
            echo "</body>" >> "$TARGET_HTML"
            echo "</html>" >> "$TARGET_HTML"

            # --- Add Link to Main Index Page ---
            echo "  <li><a href='./$PAGE_PATH/'>$SERVICE_NAME</a></li>" >> _site/index.html
            
          done
          
          # --- Close the list, main, and body tags on the index page ---
          echo "  </ul>" >> _site/index.html
          echo "</main>" >> _site/index.html
          echo "</body>" >> _site/index.html
          echo "</html>" >> _site/index.html
          
          echo "Docs build complete. Final structure:"
          tree _site
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
